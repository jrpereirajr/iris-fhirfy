Class dc.jrpereira.fhirfy.samples.fhirbundlecreator.Main Extends %RegisteredObject
{

Method FhirBundleCreator(csvFile As %String) As %String [ Language = python ]
{
    import sys
    import os
    import uuid

    # Add the path to the Python script
    sys.path.append("/home/irisowner/dev/python/fhir_bundle_creator")
    
    # Validate a valid csv file name was provided
    if not csvFile or not os.path.isfile(csvFile):
        raise Exception("Please provide a valid csv file")

    # Import the modules generated by FHIRfy to convert a CSV to a FHIR Bundle
    from data_parser import DataParser
    from fhir_bundle_creator import FHIRBundleCreator

    # Parse the raw data
    data_parser = DataParser()
    patient_data = data_parser.parse_data(csvFile)

    # Create a FHIR Bundle resource
    fhir_bundle_creator = FHIRBundleCreator()
    fhir_bundle = fhir_bundle_creator.create_fhir_bundle(patient_data)

    # Save the FHIR Bundle resource to a file
    fhir_bundle_filename = f"/tmp/{str(uuid.uuid4())}.json"
    with open(fhir_bundle_filename, 'w') as f:
        f.write(fhir_bundle.json())

    # Return the FHIR Bundle filename
    return fhir_bundle_filename
}

}
